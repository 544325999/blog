/*!
 * ZUI: 图片裁剪工具 - v1.7.0 - 2017-06-17
 * http://zui.sexy
 * GitHub: https://github.com/easysoft/zui.git 
 * Copyright (c) 2017 cnezsoft.com; Licensed MIT
 */
!function(dQfBeKbKeU,ePgVedcjeO,aKfigPdVeU){"use strict";dQfBeKbKeU.fn.draggable||console.error("img-cutter requires draggable.js"),dQfBeKbKeU.zui.imgReady||console.error("img-cutter requires image.ready.js");var aAbJfCfMaM="zui.imgCutter",hdfVbUgLaa=function(ePgVedcjeO,aKfigPdVeU){this.$=dQfBeKbKeU(ePgVedcjeO),this.initOptions(aKfigPdVeU),this.init()};hdfVbUgLaa.DEFAULTS={coverColor:"#000",coverOpacity:.6,defaultWidth:128,defaultHeight:128,minWidth:48,minHeight:48},hdfVbUgLaa.prototype.callEvent=function(dQfBeKbKeU,ePgVedcjeO){var hdfVbUgLaa=this.$.callEvent(dQfBeKbKeU+"."+aAbJfCfMaM,ePgVedcjeO,this);return!(hdfVbUgLaa.result!==aKfigPdVeU&&!hdfVbUgLaa.result)},hdfVbUgLaa.prototype.initOptions=function(ePgVedcjeO){this.options=dQfBeKbKeU.extend({},hdfVbUgLaa.DEFAULTS,this.$.data(),ePgVedcjeO),this.options.coverOpacityIE=100*this.options.coverOpacity,this.clipWidth=this.options.defaultWidth,this.clipHeight=this.options.defaultHeight},hdfVbUgLaa.prototype.init=function(){this.initDom(),this.initSize(),this.bindEvents()},hdfVbUgLaa.prototype.initDom=function(){this.$canvas=this.$.children(".canvas"),this.$img=this.$canvas.children("img"),this.$actions=this.$.children(".actions"),this.$btn=this.$.find(".img-cutter-submit"),this.$preview=this.$.find(".img-cutter-preview"),this.options.img=this.$img.attr("src"),this.$canvas.append('<div class="cover" style="background: {coverColor}; opacity: {coverOpacity}; filter:alpha(opacity={coverOpacityIE});"></div><div class="controller" style="width: {defaultWidth}px; height: {defaultHeight}px"><div class="control" data-direction="top"></div><div class="control" data-direction="right"></div><div class="control" data-direction="bottom"></div><div class="control" data-direction="left"></div><div class="control" data-direction="top-left"></div><div class="control" data-direction="top-right"></div><div class="control" data-direction="bottom-left"></div><div class="control" data-direction="bottom-right"></div></div><div class="cliper"><img src="{img}"/></div>'.format(this.options)),this.$cover=this.$canvas.children(".cover"),this.$controller=this.$canvas.children(".controller"),this.$cliper=this.$canvas.children(".cliper"),this.$chipImg=this.$cliper.children("img"),this.options.fixedRatio&&this.$.addClass("fixed-ratio")},hdfVbUgLaa.prototype.resetImage=function(dQfBeKbKeU){var ePgVedcjeO=this;ePgVedcjeO.options.img=dQfBeKbKeU,ePgVedcjeO.$img.attr("src",dQfBeKbKeU),ePgVedcjeO.$chipImg.attr("src",dQfBeKbKeU),ePgVedcjeO.imgWidth=aKfigPdVeU,ePgVedcjeO.left=aKfigPdVeU,ePgVedcjeO.initSize()},hdfVbUgLaa.prototype.initSize=function(){var aAbJfCfMaM=this;aAbJfCfMaM.imgWidth||dQfBeKbKeU.zui.imgReady(aAbJfCfMaM.options.img,function(){aAbJfCfMaM.imgWidth=this.width,aAbJfCfMaM.imgHeight=this.height,aAbJfCfMaM.callEvent("ready")});var hdfVbUgLaa=setInterval(function(){aAbJfCfMaM.imgWidth&&(clearInterval(hdfVbUgLaa),aAbJfCfMaM.width=ePgVedcjeO.min(aAbJfCfMaM.imgWidth,aAbJfCfMaM.$.width()),aAbJfCfMaM.$canvas.css("width",this.width),aAbJfCfMaM.$cliper.css("width",this.width),aAbJfCfMaM.height=aAbJfCfMaM.$canvas.height(),aAbJfCfMaM.left===aKfigPdVeU&&(aAbJfCfMaM.left=ePgVedcjeO.floor((aAbJfCfMaM.width-aAbJfCfMaM.$controller.width())/2),aAbJfCfMaM.top=ePgVedcjeO.floor((aAbJfCfMaM.height-aAbJfCfMaM.$controller.height())/2)),aAbJfCfMaM.refreshSize())},0)},hdfVbUgLaa.prototype.refreshSize=function(dQfBeKbKeU){var aKfigPdVeU=this.options;this.clipWidth=ePgVedcjeO.max(aKfigPdVeU.minWidth,ePgVedcjeO.min(this.width,this.clipWidth)),this.clipHeight=ePgVedcjeO.max(aKfigPdVeU.minHeight,ePgVedcjeO.min(this.height,this.clipHeight)),aKfigPdVeU.fixedRatio&&(dQfBeKbKeU&&"height"===dQfBeKbKeU?(this.clipWidth=ePgVedcjeO.max(aKfigPdVeU.minWidth,ePgVedcjeO.min(this.width,this.clipHeight*aKfigPdVeU.defaultWidth/aKfigPdVeU.defaultHeight)),this.clipHeight=this.clipWidth*aKfigPdVeU.defaultHeight/aKfigPdVeU.defaultWidth):(this.clipHeight=ePgVedcjeO.max(aKfigPdVeU.minHeight,ePgVedcjeO.min(this.height,this.clipWidth*aKfigPdVeU.defaultHeight/aKfigPdVeU.defaultWidth)),this.clipWidth=this.clipHeight*aKfigPdVeU.defaultWidth/aKfigPdVeU.defaultHeight)),this.left=ePgVedcjeO.min(this.width-this.clipWidth,ePgVedcjeO.max(0,this.left)),this.top=ePgVedcjeO.min(this.height-this.clipHeight,ePgVedcjeO.max(0,this.top)),this.right=this.left+this.clipWidth,this.bottom=this.top+this.clipHeight,this.$controller.css({left:this.left,top:this.top,width:this.clipWidth,height:this.clipHeight}),this.$cliper.css("clip","rect({0}px {1}px {2}px {3}px".format(this.top,this.left+this.clipWidth,this.top+this.clipHeight,this.left)),this.callEvent("change",{top:this.top,left:this.left,bottom:this.bottom,right:this.right,width:this.clipWidth,height:this.clipHeight})},hdfVbUgLaa.prototype.getData=function(){var dQfBeKbKeU=this;return dQfBeKbKeU.data={originWidth:dQfBeKbKeU.imgWidth,originHeight:dQfBeKbKeU.imgHeight,scaleWidth:dQfBeKbKeU.width,scaleHeight:dQfBeKbKeU.height,width:dQfBeKbKeU.right-dQfBeKbKeU.left,height:dQfBeKbKeU.bottom-dQfBeKbKeU.top,left:dQfBeKbKeU.left,top:dQfBeKbKeU.top,right:dQfBeKbKeU.right,bottom:dQfBeKbKeU.bottom,scaled:dQfBeKbKeU.imgWidth!=dQfBeKbKeU.width||dQfBeKbKeU.imgHeight!=dQfBeKbKeU.height},dQfBeKbKeU.data},hdfVbUgLaa.prototype.bindEvents=function(){var aKfigPdVeU=this,aAbJfCfMaM=this.options;this.$.resize(dQfBeKbKeU.proxy(this.initSize,this)),this.$btn.hover(function(){aKfigPdVeU.$.toggleClass("hover")}).click(function(){var ePgVedcjeO=aKfigPdVeU.getData();if(aKfigPdVeU.callEvent("before",ePgVedcjeO)){var hdfVbUgLaa=aAbJfCfMaM.post||aAbJfCfMaM.get||aAbJfCfMaM.url||null;null!==hdfVbUgLaa&&dQfBeKbKeU.ajax({type:aAbJfCfMaM.post?"POST":"GET",url:hdfVbUgLaa,data:ePgVedcjeO}).done(function(dQfBeKbKeU){aKfigPdVeU.callEvent("done",dQfBeKbKeU)}).fail(function(dQfBeKbKeU){aKfigPdVeU.callEvent("fail",dQfBeKbKeU)}).always(function(dQfBeKbKeU){aKfigPdVeU.callEvent("always",dQfBeKbKeU)})}}),this.$controller.draggable({move:!1,container:this.$canvas,drag:function(dQfBeKbKeU){aKfigPdVeU.left+=dQfBeKbKeU.smallOffset.x,aKfigPdVeU.top+=dQfBeKbKeU.smallOffset.y,aKfigPdVeU.refreshSize()}}),this.$controller.children(".control").draggable({move:!1,container:this.$canvas,stopPropagation:!0,drag:function(dQfBeKbKeU){var hdfVbUgLaa=dQfBeKbKeU.element.data("direction"),diaWgfhd=dQfBeKbKeU.smallOffset,dQfBeKbKeUdQfBeKbKeU=!1;switch(hdfVbUgLaa){case"left":case"top-left":case"bottom-left":aKfigPdVeU.left+=diaWgfhd.x,aKfigPdVeU.left=ePgVedcjeO.min(aKfigPdVeU.right-aAbJfCfMaM.minWidth,ePgVedcjeO.max(0,aKfigPdVeU.left)),aKfigPdVeU.clipWidth=aKfigPdVeU.right-aKfigPdVeU.left;break;case"right":case"top-right":case"bottom-right":aKfigPdVeU.clipWidth+=diaWgfhd.x,aKfigPdVeU.clipWidth=ePgVedcjeO.min(aKfigPdVeU.width-aKfigPdVeU.left,ePgVedcjeO.max(aAbJfCfMaM.minWidth,aKfigPdVeU.clipWidth))}switch(hdfVbUgLaa){case"top":case"top-left":case"top-right":aKfigPdVeU.top+=diaWgfhd.y,aKfigPdVeU.top=ePgVedcjeO.min(aKfigPdVeU.bottom-aAbJfCfMaM.minHeight,ePgVedcjeO.max(0,aKfigPdVeU.top)),aKfigPdVeU.clipHeight=aKfigPdVeU.bottom-aKfigPdVeU.top,dQfBeKbKeUdQfBeKbKeU=!0;break;case"bottom":case"bottom-left":case"bottom-right":aKfigPdVeU.clipHeight+=diaWgfhd.y,aKfigPdVeU.clipHeight=ePgVedcjeO.min(aKfigPdVeU.height-aKfigPdVeU.top,ePgVedcjeO.max(aAbJfCfMaM.minHeight,aKfigPdVeU.clipHeight)),dQfBeKbKeUdQfBeKbKeU=!0}aKfigPdVeU.refreshSize(dQfBeKbKeUdQfBeKbKeU)}})},dQfBeKbKeU.fn.imgCutter=function(ePgVedcjeO){return this.each(function(){var aKfigPdVeU=dQfBeKbKeU(this),diaWgfhd=aKfigPdVeU.data(aAbJfCfMaM),dQfBeKbKeUdQfBeKbKeU="object"==typeof ePgVedcjeO&&ePgVedcjeO;diaWgfhd||aKfigPdVeU.data(aAbJfCfMaM,diaWgfhd=new hdfVbUgLaa(this,dQfBeKbKeUdQfBeKbKeU)),"string"==typeof ePgVedcjeO&&diaWgfhd[ePgVedcjeO]()})},dQfBeKbKeU.fn.imgCutter.Constructor=hdfVbUgLaa,dQfBeKbKeU(function(){dQfBeKbKeU('[data-toggle="imgCutter"]').imgCutter()})}(jQuery,Math,void 0);