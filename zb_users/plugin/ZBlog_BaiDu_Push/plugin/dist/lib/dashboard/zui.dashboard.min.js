/*!
 * ZUI: 仪表盘 - v1.7.0 - 2017-06-17
 * http://zui.sexy
 * GitHub: https://github.com/easysoft/zui.git 
 * Copyright (c) 2017 cnezsoft.com; Licensed MIT
 */
!function(aS,gj,fL){"use strict";function dU(aS,fL,dU,dY){return gj.abs((dU-aS)*(dY-fL))}function dY(aS,gj,fL,dU,dY,ef){return aS>=fL&&aS<=dY&&gj>=dU&&gj<=ef}function ef(aS,fL,ef,dJ,eW,fX,fK,bM){var fF=gj.max(aS,eW),di=gj.max(fL,fX),aA=gj.min(ef,fK),ei=gj.min(dJ,bM);return dY(fF,di,aS,fL,ef,dJ)&&dY(aA,ei,aS,fL,ef,dJ)&&dY(fF,di,eW,fX,fK,bM)&&dY(aA,ei,eW,fX,fK,bM)?dU(fF,di,aA,ei):0}var dJ=aS.zui.Messager?new aS.zui.Messager({placement:"top",time:1500,close:0,scale:!1,fade:!1}):0,eW=function(gj,fL){this.$=aS(gj),this.options=this.getOptions(fL),this.draggable=this.$.hasClass("dashboard-draggable")||this.options.draggable,this.init()};eW.DEFAULTS={minHeight:100,height:360,shadowType:"normal",sensitive:!1,circleShadowSize:100,onlyRefreshBody:!0,resizable:!0,resizeMessage:!1},eW.prototype.getOptions=function(gj){return gj=aS.extend({},eW.DEFAULTS,this.$.data(),gj)},eW.prototype.handleRemoveEvent=function(){var gj=this.options.afterPanelRemoved,dU=this.options.panelRemovingTip;this.$.on("click",".remove-panel",function(){var dY=aS(this).closest(".panel"),ef=dY.data("name")||dY.find(".panel-heading").text().replace("\n","").replace(/(^\s*)|(\s*$)/g,""),dJ=dY.attr("data-id");(dU===fL||dU===!1||confirm(dU.format(ef)))&&(dY.parent().remove(),gj&&aS.isFunction(gj)&&gj(dJ))})},eW.prototype.handleRefreshEvent=function(){var gj=this,fL=this.options.onlyRefreshBody;this.$.on("click",".refresh-panel",function(){var dU=aS(this).closest(".panel");gj.refresh(dU,fL)})},eW.prototype.handleDraggable=function(){var fL=this.$,dY=this.options,dJ="circle"===dY.shadowType,eW=dY.circleShadowSize,fX=eW/2,fK=dY.afterOrdered;this.$.addClass("dashboard-draggable"),this.$.on("mousedown",".panel-actions, .drag-disabled",function(aS){aS.stopPropagation()});var bM;this.$.on("mousedown",".panel-heading, .panel-drag-handler",function(fF){function di(fL){var dJ=aSaS.data("mouseOffset");eK=fL.pageX-dJ.x,ff=fL.pageY-dJ.y,dX=eK+dYaS,ge=ff+efaS,aSaS.css({left:eK,top:ff}),gG.find(".dragging-in").removeClass("dragging-in"),bd=!1,bg=null;var eW,fX=0;gG.children(":not(.dragging-col)").each(function(){var dJ=aS(this);if(dJ.hasClass("dragging-col-holder"))return bd=!dY.sensitive||fX<100,!0;var fK=dJ.children(".panel"),bM=fK.offset(),fF=fK.width(),di=fK.height(),aA=bM.left,ei=bM.top;if(dY.sensitive)aA-=fLaS.left,ei-=fLaS.top,eW=ef(eK,ff,dX,ge,aA,ei,aA+fF,ei+di),eW>100&&eW>fX&&eW>gj.min(dU(eK,ff,dX,ge),dU(aA,ei,aA+fF,ei+di))/3&&(fX=eW,bg=dJ);else{var gI=fL.pageX,dF=fL.pageY;if(gI>aA&&dF>ei&&gI<aA+fF&&dF<ei+di)return bg=dJ,!1}}),bg&&(gI&&clearTimeout(gI),dF=bg,gI=setTimeout(aA,50)),fL.preventDefault()}function aA(){dF&&(dF.addClass("dragging-in"),bd?dUaS.insertAfter(dF):dUaS.insertBefore(dF),fL.addClass("dashboard-holding"),gI=null,dF=null)}function ei(gj){gI&&clearTimeout(gI);var dU=fV.data("order");fV.parent().insertAfter(dUaS);var dY=0,ef={};gG.children(":not(.dragging-col-holder)").each(function(){var gj=aS(this).children(".panel");gj.data("order",++dY),ef[gj.data("id")||gj.attr("id")]=dY,gj.parent().attr("data-order",dY)}),dU!=ef[fV.data("id")||fV.attr("id")]&&(gG.data("orders",ef),fK&&aS.isFunction(fK)&&fK(ef)),aSaS.remove(),fL.removeClass("dashboard-holding"),fL.find(".dragging-col").removeClass("dragging-col"),fL.find(".panel-dragging").removeClass("panel-dragging"),gG.find(".dragging-in").removeClass("dragging-in"),fL.removeClass("dashboard-dragging"),aS(document).off("mousemove",di).off("mouseup",ei),gj.preventDefault()}var eK,ff,dX,ge,gI,bg,bd,dF,fV=aS(this).closest(".panel"),gR=fV.parent(),gG=fV.closest(".row"),aSaS=fV.clone().addClass("panel-dragging-shadow"),gjaS=fV.offset(),fLaS=fL.offset(),dUaS=gG.find(".dragging-col-holder"),dYaS=fV.width(),efaS=fV.height();dUaS.length||(dUaS=aS('<div class="dragging-col-holder"><div class="panel"></div></div>').removeClass("dragging-col").appendTo(gG)),bM&&dUaS.removeClass(bM),dUaS.addClass(bM=gR.attr("class")),dUaS.insertBefore(gR).find(".panel").replaceWith(fV.clone().addClass("panel-dragging panel-dragging-holder")),fL.addClass("dashboard-dragging"),fV.addClass("panel-dragging").parent().addClass("dragging-col"),aSaS.css({left:gjaS.left-fLaS.left,top:gjaS.top-fLaS.top,width:dYaS,height:efaS}).appendTo(fL).data("mouseOffset",{x:fF.pageX-gjaS.left+fLaS.left,y:fF.pageY-gjaS.top+fLaS.top}),dJ&&(aSaS.addClass("circle"),setTimeout(function(){aSaS.css({left:fF.pageX-fLaS.left-fX,top:fF.pageY-fLaS.top-fX,width:eW,height:eW}).data("mouseOffset",{x:fLaS.left+fX,y:fLaS.top+fX})},100)),aS(document).on("mousemove",di).on("mouseup",ei),fF.preventDefault()})},eW.prototype.handlePanelPadding=function(){this.$.find(".panel-body > table, .panel-body > .list-group").parent().addClass("no-padding")},eW.prototype.updatePanelHeight=function(){var fL=this,dU=fL.options.height,dY=fL.options.minHeight,ef={};return fL.id&&aS.zui.store&&(ef=aS.zui.store.pageGet("zui.dashboard."+fL.id+".sizeConfig",ef)),this.$.children(".row").each(function(){var fL=aS(this),dJ=fL.width(),eW=[],fX=[],fK=0;fL.children(":not(.dragging-col-holder)").each(function(){var gj=aS(this),fL=gj.width();fK+fL>dJ?(fX.length&&eW.push(fX),fX=[gj],fK=fL):(fK+=fL,fX.push(gj))}),fX.length&&eW.push(fX),eW.length&&aS.each(eW,function(fL){fX=eW[fL];var dJ=0,fK=[],bM=!1;aS.each(fX,function(aS){var dU=fX[aS].data("row-id",fL),eW=dU.children(".panel:first");if(fK.push(eW),!bM){var fF=eW.data("newHeight");if(fF)eW.data("newHeight",null).data("height",fF),dJ=gj.max(dY,fF),bM=!0;else{var di=eW.data("height")||ef[eW.data("id")];di&&(dJ=gj.max(dJ,di))}}}),dJ||(dJ=dU),aS.each(fK,function(aS){var gj=fK[aS].css("height",dJ);ef[gj.data("id")]=gj.data("height")})})}),fL.id&&aS.zui.store&&aS.zui.store.pageSet("zui.dashboard."+fL.id+".sizeConfig",ef),ef},eW.prototype.handleResizeEvent=function(){var fL=this,dU=fL.options,dY=dU.resizable,ef=dU.onResize,eW=dU.minHeight,fX=dU.resizeMessage,fK=fX&&dJ;fL.$.on("mousedown",".resize-handle",function(dU){var dY=aS(this),fX=dY.hasClass("resize-vertical"),bM=dY.parent().addClass("resizing").toggleClass("resizing-v",fX).toggleClass("resizing-h",!fX),fF=bM.closest(".row"),di=bM.children(".panel"),aA=dU.pageX,ei=dU.pageY,eK=bM.width(),ff=di.height(),dX=fF.width(),ge=gj.round(12*eK/dX),gI=ge;fX||bM.attr("data-grid",ge);var bg=function(aS){if(fX)di.css("height",gj.max(eW,ff+(aS.pageY-ei)));else{var fL=aS.pageX,dU=gj.max(1,gj.min(12,gj.round(12*(eK+(fL-aA))/dX)));gI!=dU&&(bM.attr("data-grid",dU).css("width",100*dU/12+"%"),fK&&dJ[dJ.isShow?"update":"show"](gj.round(100*dU/12)+"% ("+dU+"/12)"),gI=dU)}aS.preventDefault(),aS.stopPropagation()},bd=function(dU){if(bM.removeClass("resizing resizing-v resizing-h"),fX){var dY=gj.max(eW,ff+(dU.pageY-ei));if(dY!==ff){if(aS.isFunction(ef)){var fF=function(){di.css("height",ff).data("height",ff),fL.updatePanelHeight()},aA=ef({type:"vertical",id:di.data("id"),element:bM,old:ff,height:dY,revert:fF});aA===!1&&fF()}di.css("height",dY).data("newHeight",dY)}}else{var eK=bM.attr("data-grid");if(ge!=eK&&aS.isFunction(ef)){var fF=function(){bM.attr("data-grid",ge).css("width",null),fL.updatePanelHeight()},aA=ef({type:"horizontal",id:di.data("id"),element:bM,old:ge,grid:eK,revert:fF});aA===!1?fF():aA!==!0&&fK&&dJ.show(gj.round(100*eK/12)+"% ("+eK+"/12)")}}fL.updatePanelHeight(),aS("body").off("mousemove.resize",bg).off("mouseup.resize",bd),dU.preventDefault(),dU.stopPropagation()};aS("body").on("mousemove.resize",bg).on("mouseup.resize",bd),dU.preventDefault(),dU.stopPropagation()});var bM=fL.$.children(".row").children(":not(.dragging-col-holder)");dY!==!0&&"horizontal"!==dY||bM.append('<div class="resize-handle resize-horizontal"><i class="icon icon-resize-h"></i></div>'),dY!==!0&&"vertical"!==dY||bM.append('<div class="resize-handle resize-vertical"><i class="icon icon-resize-v"></i></div>')},eW.prototype.refresh=function(gj,dU){dU===fL&&(dU=this.options.onlyRefreshBody);var dY=this.options.afterRefresh;gj=aS(gj);var ef=gj.data("url");ef&&(gj.addClass("panel-loading").find(".panel-heading .icon-refresh,.panel-heading .icon-repeat").addClass("icon-spin"),aS.ajax({url:ef,dataType:"html"}).done(function(fL){var ef=aS(fL);ef.hasClass("panel")?gj.empty().append(ef.children()):dU?gj.find(".panel-body").empty().html(fL):gj.html(fL),aS.isFunction(dY)&&dY.call(this,{result:!0,data:fL,$panel:gj})}).fail(function(){gj.addClass("panel-error"),aS.isFunction(dY)&&dY.call(this,{result:!1,$panel:gj})}).always(function(){gj.removeClass("panel-loading"),gj.find(".panel-heading .icon-refresh,.panel-heading .icon-repeat").removeClass("icon-spin")}))},eW.prototype.init=function(){var gj=this.options,dU=this;if(dU.id=gj.id?gj.id:dU.$.attr("id"),gj.data){var dY=aS('<div class="row"/>');aS.each(gj.data,function(gj,dU){var ef=aS('<div class="col-sm-'+(dU.colWidth||4)+'"/>');dU.colAttrs&&ef.attr(dU.colAttrs);var dJ=aS('<div class="panel" data-id="'+(dU.id||aS.zui.uuid())+'"/>');if(dU.panelAttrs&&dJ.attr(dU.panelAttrs),dU.height!==fL&&dJ.data("height",dU.height),dU.content!==fL)if(aS.isFunction(dU.content)){var eW=dU.content(dJ);eW!==!0&&dJ.html(eW)}else dJ.html(dU.content);dY.append(ef.append(dJ.data("url",dU.url)))}),dU.$.append(dY)}dU.updatePanelHeight(),dU.handlePanelPadding(),dU.handleRemoveEvent(),dU.handleRefreshEvent(),gj.resizable&&dU.handleResizeEvent(),dU.draggable&&dU.handleDraggable();var ef=0;dU.$.find(".panel").each(function(){var fL=aS(this);fL.data("order",++ef),fL.attr("id")||fL.attr("id","panel"+ef),fL.attr("data-id")||fL.attr("data-id",ef),dU.refresh(fL,gj.onlyRefreshBody)}),dU.$.find('[data-toggle="tooltip"]').tooltip({container:"body"})},aS.fn.dashboard=function(gj){return this.each(function(){var fL=aS(this),dU=fL.data("zui.dashboard"),dY="object"==typeof gj&&gj;dU||fL.data("zui.dashboard",dU=new eW(this,dY)),"string"==typeof gj&&dU[gj]()})},aS.fn.dashboard.Constructor=eW}(jQuery,Math,void 0);