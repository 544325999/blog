/*!
 * ZUI: 数据表格 - v1.7.0 - 2017-06-17
 * http://zui.sexy
 * GitHub: https://github.com/easysoft/zui.git 
 * Copyright (c) 2017 cnezsoft.com; Licensed MIT
 */
!function(c){"use strict";var b="zui.datatable",g=c.zui.store,N=function(g,N){this.name=b,this.$=c(g),this.isTable="TABLE"===this.$[0].tagName,this.firstShow=!0,this.isTable?(this.$table=this.$,this.id="datatable-"+(this.$.attr("id")||c.zui.uuid())):(this.$datatable=this.$.addClass("datatable"),this.$.attr("id")?this.id=this.$.attr("id"):(this.id="datatable-"+c.zui.uuid(),this.$.attr("id",this.id))),this.getOptions(N),this.load(),this.callEvent("ready")};N.DEFAULTS={checkable:!1,checkByClickRow:!0,checkedClass:"active",checkboxName:null,selectable:!0,sortable:!1,storage:!0,fixedHeader:!1,fixedHeaderOffset:0,fixedLeftWidth:"30%",fixedRightWidth:"30%",flexHeadDrag:!0,scrollPos:"in",rowHover:!0,colHover:!0,hoverClass:"hover",colHoverClass:"col-hover",fixCellHeight:!0,mergeRows:!1,minColWidth:20,minFixedLeftWidth:200,minFixedRightWidth:200,minFlexAreaWidth:200},N.prototype.getOptions=function(b){var g=this.$;b=c.extend({},N.DEFAULTS,this.$.data(),b),b.tableClass=b.tableClass||"",b.tableClass=" "+b.tableClass+" table-datatable",c.each(["bordered","condensed","striped","condensed","fixed"],function(c,N){N="table-"+N,g.hasClass(N)&&(b.tableClass+=" "+N)}),(g.hasClass("table-hover")||b.rowHover)&&(b.tableClass+=" table-hover"),b.checkable&&c.fn.selectable||(b.selectable=!1),this.options=b},N.prototype.load=function(g){var N,gX=this.options;if(c.isFunction(g))g=g(this.data,this),g.keepSort=!0;else if(c.isPlainObject(g))this.data=g;else if("string"==typeof g){var f=c(g);f.length&&(this.$table=f.first(),this.$table.data(b,this),this.isTable=!0),g=null}else g=gX.data;if(!g){if(!this.isTable)throw new Error("No data avaliable!");g={cols:[],rows:[]},N=g.cols;var i,bY,gT,gK,a,T,fB=g.rows,e=this.$table;e.find("thead > tr:first").children("th").each(function(){bY=c(this),N.push(c.extend({text:bY.html(),flex:bY.hasClass("flex-col"),width:"auto",cssClass:bY.attr("class"),css:bY.attr("style"),type:"string",ignore:bY.hasClass("ignore"),sort:!bY.hasClass("sort-disabled"),mergeRows:bY.attr("merge-rows")},bY.data()))}),e.find("tbody > tr").each(function(){gT=c(this),a=c.extend({data:[],checked:!1,cssClass:gT.attr("class"),css:gT.attr("style"),id:gT.attr("id")},gT.data()),gT.children("td").each(function(){if(gK=c(this),T=gK.attr("colspan")||1,a.data.push(c.extend({cssClass:gK.attr("class"),css:gK.attr("style"),text:gK.html(),colSpan:T,title:gK.attr("title")},gK.data())),T>1)for(i=1;i<T;i++)a.data.push({empty:!0})}),fB.push(a)});var Q=e.find("tfoot");Q.length&&(g.footer=c('<table class="table'+gX.tableClass+'"></table>').append(Q))}g.flexStart=-1,g.flexEnd=-1,N=g.cols,g.colsLength=N.length;for(var i=0;i<g.colsLength;++i){var d=N[i];d.flex&&(g.flexStart<0&&(g.flexStart=i),g.flexEnd=i)}0===g.flexStart&&g.flexEnd===g.colsLength&&(g.flexStart=-1,g.flexEnd=-1),g.flexArea=g.flexStart>=0,g.fixedRight=g.flexEnd>=0&&g.flexEnd<g.colsLength-1,g.fixedLeft=g.flexStart>0,g.flexStart<0&&g.flexEnd<0&&(g.fixedLeft=!0,g.flexStart=g.colsLength,g.flexEnd=g.colsLength),this.data=g,this.callEvent("afterLoad",{data:g}),this.render()},N.prototype.render=function(){var g,N,gX,f,i=this,bY=i.$datatable||(i.isTable?c('<div class="datatable" id="'+i.id+'"/>'):i.$datatable),gT=i.options,gK=i.data,a=i.data.cols,T=i.data.rows,fB=gT.checkable,e='<div class="datatable-rows-span datatable-span"><div class="datatable-wrapper"><table class="table"></table></div></div>',Q='<div class="datatable-head-span datatable-span"><div class="datatable-wrapper"><table class="table"><thead></thead></table></div></div>';bY.children(".datatable-head, .datatable-rows, .scroll-wrapper").remove(),bY.toggleClass("sortable",gT.sortable);var d,F,gR,cP=c('<div class="datatable-head"/>');for(g=c("<tr/>"),gX=c("<tr/>"),f=c("<tr/>"),N=0;N<a.length;N++)gR=a[N],d=N<gK.flexStart?g:N>=gK.flexStart&&N<=gK.flexEnd?f:gX,0===N&&fB&&d.append('<th data-index="check" class="check-all check-btn"><i class="icon-check-empty"></i></th>'),gR.ignore||(F=c("<th/>"),F.toggleClass("sort-down","down"===gR.sort).toggleClass("sort-up","up"===gR.sort).toggleClass("sort-disabled",gR.sort===!1),F.addClass(gR.cssClass).addClass(gR.colClass).html(gR.text).attr({"data-index":N,"data-type":gR.type,style:gR.css}).css("width",gR.width),d.append(F));var cY;gK.fixedLeft&&(cY=c(Q),cY.addClass("fixed-left").find("table").addClass(gT.tableClass).find("thead").append(g),cP.append(cY)),gK.flexArea&&(cY=c(Q),cY.addClass("flexarea").find(".datatable-wrapper").append('<div class="scrolled-shadow scrolled-in-shadow"></div><div class="scrolled-shadow scrolled-out-shadow"></div>').find("table").addClass(gT.tableClass).find("thead").append(f),cP.append(cY)),gK.fixedRight&&(cY=c(Q),cY.addClass("fixed-right").find("table").addClass(gT.tableClass).find("thead").append(gX),cP.append(cY)),bY.append(cP);var eV,fe,dO,eP,h,ce,G,bT,aJ=c('<div class="datatable-rows">'),bM=T.length;g=c("<tbody/>"),gX=c("<tbody/>"),f=c("<tbody/>");for(var gKd=0;gKd<bM;++gKd){for(ce=T[gKd],"undefined"==typeof ce.id&&(ce.id=gKd),ce.index=gKd,eV=c("<tr/>"),eV.addClass(ce.cssClass).toggleClass(gT.checkedClass,!!ce.checked).attr({"data-index":gKd,"data-id":ce.id}),fe=eV.clone(),dO=eV.clone(),bT=ce.data.length,N=0;N<bT;++N)G=ce.data[N],N>0&&G.empty||(d=N<gK.flexStart?eV:N>=gK.flexStart&&N<=gK.flexEnd?fe:dO,0===N&&fB&&(h=c('<td data-index="check" class="check-row check-btn"><i class="icon-check-empty"></i></td>'),gT.checkboxName&&h.append('<input class="hide" type="checkbox" name="'+gT.checkboxName+'" value="'+ce.id+'">'),d.append(h)),a[N].ignore||(c.isPlainObject(G)?(G.row=gKd,G.index=N):G={text:G,row:gKd,index:N},ce.data[N]=G,eP=c("<td/>"),eP.html(G.text).addClass(G.cssClass).addClass(a[N].colClass).attr("colspan",G.colSpan).attr({"data-row":gKd,"data-index":N,"data-flex":!1,"data-type":a[N].type,style:G.css,title:G.title||""}).css("width",a[N].width),d.append(eP)));g.append(eV),f.append(fe),gX.append(dO)}var J;gK.fixedLeft&&(J=c(e),J.addClass("fixed-left").find("table").addClass(gT.tableClass).append(g),aJ.append(J)),gK.flexArea&&(J=c(e),J.addClass("flexarea").find(".datatable-wrapper").append('<div class="scrolled-shadow scrolled-in-shadow"></div><div class="scrolled-shadow scrolled-out-shadow"></div>').find("table").addClass(gT.tableClass).append(f),aJ.append(J)),gK.fixedRight&&(J=c(e),J.addClass("fixed-right").find("table").addClass(gT.tableClass).append(gX),aJ.append(J)),bY.append(aJ),gK.flexArea&&bY.append('<div class="scroll-wrapper"><div class="scroll-slide scroll-pos-'+gT.scrollPos+'"><div class="bar"></div></div></div>');var dW=bY.children(".datatable-footer").detach();gK.footer?(bY.append(c('<div class="datatable-footer"/>').append(gK.footer)),gK.footer=null):dW.length&&bY.append(dW),i.$datatable=bY.data(b,i),i.isTable&&i.firstShow&&(i.$table.attr("data-datatable-id",this.id).hide().after(bY),i.firstShow=!1),i.bindEvents(),i.refreshSize(),i.callEvent("render")},N.prototype.bindEvents=function(){var b=this,N=this.data,gX=this.options,f=this.$datatable,i=b.$dataSpans=f.children(".datatable-head, .datatable-rows").find(".datatable-span"),bY=b.$rowsSpans=f.children(".datatable-rows").children(".datatable-rows-span"),gT=b.$headSpans=f.children(".datatable-head").children(".datatable-head-span"),gK=b.$cells=i.find("td, th"),a=b.$dataCells=gK.filter("td");b.$headCells=gK.filter("th");var T=b.$rows=b.$rowsSpans.find(".table > tbody > tr");if(gX.rowHover){var fB=gX.hoverClass;bY.on("mouseenter","td",function(){a.filter("."+fB).removeClass(fB),T.filter("."+fB).removeClass(fB),T.filter('[data-index="'+c(this).addClass(fB).closest("tr").data("index")+'"]').addClass(fB)}).on("mouseleave","td",function(){a.filter("."+fB).removeClass(fB),T.filter("."+fB).removeClass(fB)})}if(gX.colHover){var e=gX.colHoverClass;gT.on("mouseenter","th",function(){gK.filter("."+e).removeClass(e),gK.filter('[data-index="'+c(this).data("index")+'"]').addClass(e)}).on("mouseleave","th",function(){gK.filter("."+e).removeClass(e)})}if(N.flexArea){var Q,d,F,gR,cP,cY,eV,fe=f.find(".scroll-slide"),dO=f.find(".datatable-span.flexarea"),eP=f.find(".datatable-span.fixed-left"),h=f.find(".datatable-span.flexarea .table"),ce=fe.children(".bar"),G=b.id+"_scrollOffset";b.width=f.width(),f.resize(function(){b.width=f.width()});var bT=function(c,b){cP=Math.max(0,Math.min(Q-d,c)),b||f.addClass("scrolling"),ce.css("left",cP),eV=0-Math.floor((F-Q)*cP/(Q-d)),h.css("left",eV),gR=cP,f.toggleClass("scrolled-in",cP>2).toggleClass("scrolled-out",cP<Q-d-2),gX.storage&&g.pageSet(G,cP)},aJ=function(){Q=dO.width(),fe.width(Q).css("left",eP.width()),F=h.width(),d=Math.floor(Q*Q/F),ce.css("width",d),h.css("min-width",Q),f.toggleClass("show-scroll-slide",F>Q),cY||Q===d||(cY=!0,bT(g.pageGet(G,0),!0)),f.hasClass("size-changing")&&bT(cP,!0)};dO.resize(aJ),gX.storage&&aJ();var bM={move:!1,stopPropagation:!0,drag:function(c){bT(ce.position().left+c.smallOffset.x*(c.element.hasClass("bar")?1:-1))},finish:function(){f.removeClass("scrolling")}};c.fn.draggable?(ce.draggable(bM),gX.flexHeadDrag&&f.find(".datatable-head-span.flexarea").draggable(bM)):console.error("DataTable requires draggable.js to improve UI."),fe.mousedown(function(c){var b=c.pageX-fe.offset().left;bT(b-d/2)})}if(gX.checkable){var gKd,J=b.id+"_checkedStatus",dW=gX.checkedClass,cV=function(){var f=bY.first().find(".table > tbody > tr"),i=f.filter("."+dW);gX.checkboxName&&f.find(".check-row input:checkbox").prop("checked",!1);var gK={checkedAll:f.length===i.length&&i.length>0,checks:i.map(function(){return gKd=c(this).data("id"),gX.checkboxName&&c(this).find(".check-row input:checkbox").prop("checked",!0),gKd}).toArray()};b.checks=gK,c.each(N.rows,function(b,g){g.checked=c.inArray(g.id,gK.checks)>-1}),gT.find(".check-all").toggleClass("checked",!!gK.checkedAll),gX.storage&&g.pageSet(J,gK),b.callEvent("checksChanged",{checks:gK})},ag=function(b,g){var N=c(b).closest("tr");void 0===g&&(g=!N.hasClass(dW)),T.filter('[data-index="'+N.data("index")+'"]').toggleClass(dW,!!g)},cM="click.zui.datatable.check";if(gX.selectable){var j={selector:".datatable-rows tr",trigger:".datatable-rows",start:function(b){var g=c(b.target).closest(".check-row, .check-btn");if(g.length)return g.is(".check-row")&&(ag(g),cV()),!1},rangeFunc:function(c,b){return Math.max(c.top,b.top)<Math.min(c.top+c.height,b.top+b.height)},select:function(c){ag(c.target,!0)},unselect:function(c){ag(c.target,!1)},finish:function(c){cV()}};c.isPlainObject(gX.selectable)&&c.extend(j,gX.selectable),this.$datatable.selectable(j)}else this.$rowsSpans.off(cM).on(cM+"row",gX.checkByClickRow?"tr":".check-row",function(){ag(this),cV()});if(this.$datatable.off(cM).on("click.zui.datatable.check",".check-all",function(){T.toggleClass(dW,c(this).toggleClass("checked").hasClass("checked")),cV()}).on(cM+".none",".check-none",function(){T.toggleClass(dW,!1),cV()}).on(cM+".inverse",".check-inverse",function(){T.toggleClass(dW),cV()}),gX.storage){var k=g.pageGet(J);k&&(gT.find(".check-all").toggleClass("checked",k.checkedAll),k.checkedAll?T.addClass(dW):(T.removeClass(dW),c.each(k.checks,function(c,b){T.filter('[data-id="'+b+'"]').addClass(dW)})),k.checks.length&&cV())}}if(gX.fixedHeader){var l,m,n,o=f.children(".datatable-head"),p=gX.fixedHeaderOffset||c(".navbar.navbar-fixed-top").height()||0,q=function(){l=f.offset().top,n=c(window).scrollTop(),m=f.height(),f.toggleClass("head-fixed",n+p>l&&n+p<l+m),f.hasClass("head-fixed")?o.css({width:f.width(),top:p}):o.attr("style","")};c(window).scroll(q),q()}gX.sortable?(gT.on("click","th:not(.sort-disabled, .check-btn)",function(){f.hasClass("size-changing")||b.sortTable(c(this))}),gX.storage&&b.sortTable()):gX.mergeRows&&this.mergeRows()},N.prototype.mergeRows=function(){for(var b=this.$rowsSpans.find(".table > tbody > tr > td"),g=this.data.cols,N=0;N<g.length;N++){var gX=g[N];if(gX.mergeRows){var f=b.filter('[data-index="'+N+'"]');if(f.length>1){var i,bY;f.each(function(){var b=c(this);i&&b.html()===i.html()?(bY=i.attr("rowspan")||1,"number"!=typeof bY&&(bY=parseInt(bY),isNaN(bY)&&(bY=1)),i.attr("rowspan",bY+1).css("vertical-align","middle"),b.remove()):i=b})}}}},N.prototype.sortTable=function(b){var g=c.zui.store,N=this.options,gX=this.id+"_datatableSorter",f=N.storage?g.pageGet(gX):null;if(b||(b=f?this.$headCells.filter('[data-index="'+f.index+'"]').addClass("sort-"+f.type):this.$headCells.filter(".sort-up, .sort-down").first()),b.length){var i,bY,gT,gK=this.data,a=gK.cols,T=gK.rows,fB=this.$headCells;i=!b.hasClass("sort-up"),gK.keepSort&&(i=!i),gK.keepSort=null,fB.removeClass("sort-up sort-down"),b.addClass(i?"sort-up":"sort-down"),gT=b.data("index"),c.each(a,function(c,b){c==gT||"up"!==b.sort&&"down"!==b.sort?c==gT&&(b.sort=i?"up":"down",bY=b.type):b.sort=!0});var e,Q,d,F=this.$dataCells.filter('[data-index="'+gT+'"]');T.sort(function(c,b){return c=c.data[gT],b=b.data[gT],e=F.filter('[data-row="'+c.row+'"]').text(),Q=F.filter('[data-row="'+b.row+'"]').text(),"number"===bY?(e=parseFloat(e),Q=parseFloat(Q)):"date"===bY?(e=Date.parse(e),Q=Date.parse(Q)):(e=e.toLowerCase(),Q=Q.toLowerCase()),d=e>Q?1:e<Q?-1:0,i&&(d*=-1),d});var gR,cP,cY,eV=this.$rows,fe=[];c.each(T,function(b,g){gR=eV.filter('[data-index="'+g.index+'"]'),gR.each(function(b){cY=c(this),cP=fe[b],cP?cP.after(cY):cY.parent().prepend(cY),fe[b]=cY})}),f={index:gT,type:i?"up":"down"},N.storage&&g.pageSet(gX,f),this.callEvent("sort",{sorter:f})}},N.prototype.refreshSize=function(){var b,g=this.$datatable,N=this.options,gX=this.data.rows;this.data.cols;if(g.find(".datatable-span.fixed-left").css("width",N.fixedLeftWidth),g.find(".datatable-span.fixed-right").css("width",N.fixedRightWidth),N.fixCellHeight){var f=function(b){var g,N,gX=0;return b.css("height","auto"),b.each(function(){g=c(this),N=g.attr("rowspan"),N&&1!=N||(gX=Math.max(gX,g.outerHeight()))}),gX},i=this.$dataCells,bY=(this.$cells,this.$headCells),gT=f(bY);bY.css("min-height",gT).css("height",gT);var gK;for(b=0;b<gX.length;++b){gK=i.filter('[data-row="'+b+'"]');var a=f(gK);gK.css("min-height",a).css("height",a)}}},N.prototype.callEvent=function(c,b){var g=this.$.callEvent(c+"."+this.name,b,this).result;return!(void 0!==g&&!g)},c.fn.datatable=function(g,gX){return this.each(function(){var f=c(this),i=f.data(b),bY="object"==typeof g&&g;i||f.data(b,i=new N(this,bY)),"string"==typeof g&&("load"!==g||!c.isPlainObject(gX)||void 0!==gX.keepSort&&null!==gX.keepSort||(gX.keepSort=!0),i[g](gX))})},c.fn.datatable.Constructor=N}(jQuery);