/*!
 * ZUI: 日历 - v1.7.0 - 2017-06-17
 * http://zui.sexy
 * GitHub: https://github.com/easysoft/zui.git 
 * Copyright (c) 2017 cnezsoft.com; Licensed MIT
 */
!function(a,d){"use strict";var aW="zui.calendar",g="number",E="string",b="undefined",Q={primary:1,green:2,red:3,blue:4,yellow:5,brown:6,purple:7},e=function(a,d){d=d||1;for(var aW=a.clone();aW.getDay()!=d;)aW.addDays(-1);return aW.clearTime(),aW},ga=function(a){var d=a.clone();return d.setDate(1),d},G=function(a,d){var aW=a.clone().clearTime(),g=d.clone().clearTime();return Math.round((g.getTime()-aW.getTime())/Date.ONEDAY_TICKS)+1},dg=function(a,d,aW){for(var g=a.clone(),E=0;g<=d;)aW(g.clone(),E++),g.addDays(1)},gK=function(d,g){if(this.name=aW,this.$=a(d),this.id=this.$.attr("id")||aW+a.zui.uuid(),this.$.attr("id",this.id),this.storeName=aW+"."+this.id,this.getOptions(g),this.getLang(),this.data=this.options.data,this.addCalendars(this.data.calendars),this.addEvents(this.data.events),this.sortEvents(),this.storeData=a.zui.store.pageGet(this.storeName,{date:"today",view:"month"}),this.date=this.options.startDate||"today",this.view=this.options.startView||"month",this.$.toggleClass("limit-event-title",g.limitEventTitle),this.options.withHeader){var E=this.$.children(".calender-header");E.length||(E=a('<header><div class="btn-toolbar"><div class="btn-group"><button type="button" class="btn btn-today">{today}</button></div><div class="btn-group"><button type="button" class="btn btn-prev"><i class="icon-chevron-left"></i></button><button type="button" class="btn btn-next"><i class="icon-chevron-right"></i></button></div><div class="btn-group"><span class="calendar-caption"></span></div></div></header>'.format(this.lang)),this.$.append(E)),this.$caption=E.find(".calendar-caption"),this.$todayBtn=E.find(".btn-today"),this.$header=E}var b=this.$.children(".calendar-views");b.length||(b=a('<div class="calendar-views"></div>'),this.$.append(b)),this.$views=b,this.$monthView=b.children(".calendar-view.month"),this.display(),this.bindEvents()};gK.DEFAULTS={langs:{zh_cn:{weekNames:["周一","周二","周三","周四","周五","周六","周日"],monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],today:"今天",year:"{0}年",month:"{0}月",yearMonth:"{0}年{1}月"},zh_tw:{weekNames:["週一","週二","週三","週四","週五","週六","週日"],monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],today:"今天",year:"{0}年",month:"{0}月",yearMonth:"{0}年{1}月"},en:{weekNames:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],monthNames:["Jan","Feb","Mar","Apr","May","June","July","Aug","Sep","Oct","Nov","Dec"],today:"Today",year:"{0}",month:"{0}",yearMonth:"{2}, {0}"}},data:{calendars:{defaultCal:{color:"#229F24"}},events:[]},limitEventTitle:!0,storage:!0,withHeader:!0,dragThenDrop:!0},gK.prototype.sortEvents=function(){var d=this.events;a.isArray(d)||(d=[]),d.sort(function(a,d){return a.start<d.start?1:a.start>d.start?-1:0}),this.events=d},gK.prototype.bindEvents=function(){var d=this.$,aW=this;d.on("click",".btn-today",function(){aW.date=new Date,aW.display(),aW.callEvent("clickTodayBtn")}).on("click",".btn-next",function(){"month"===aW.view&&aW.date.addMonths(1),aW.display(),aW.callEvent("clickNextBtn")}).on("click",".btn-prev",function(){"month"===aW.view&&aW.date.addMonths(-1),aW.display(),aW.callEvent("clickPrevBtn")}).on("click",".event",function(d){aW.callEvent("clickEvent",{element:this,event:a(this).data("event"),events:aW.events}),d.stopPropagation()}).on("click",".cell-day",function(){aW.callEvent("clickCell",{element:this,view:aW.view,date:new Date(a(this).children(".day").attr("data-date")),events:aW.events})})},gK.prototype.addCalendars=function(d,aW){var g=this;g.calendars||(g.calendars={}),a.isPlainObject(d)&&(d=[d]),a.each(d,function(d,E){if(aW||g.callEvent("beforeAddCalendars",{newCalendar:E,data:g.data})){if(E.color||(E.color="primary"),Q[E.color.toLowerCase()])E.presetColor=!0;else{var b=new a.zui.Color(E.color);E.textColor=b.contrast().hexStr()}g.calendars[E.name]=E}}),aW||(g.display(),g.callEvent("addCalendars",{newCalendars:d,data:g.data}))},gK.prototype.addEvents=function(d,aW){var Q=this;Q.events||(Q.events=[]),a.isPlainObject(d)&&(d=[d]),a.each(d,function(d,e){if(aW||Q.callEvent("beforeAddEvent",{newEvent:e,data:Q.data})){var ga=typeof e.start,dg=typeof e.end;ga!==g&&ga!==E||(e.start=new Date(e.start)),dg!==g&&dg!==E||(e.end=new Date(e.end)),typeof e.id===b&&(e.id=a.zui.uuid()),e.allDay&&(e.start.clearTime(),e.end.clearTime().addDays(1).addMilliseconds(-1)),e.days=G(e.start,e.end),Q.events.push(e)}}),aW||(Q.sortEvents(),Q.display(),Q.callEvent("addEvents",{newEvents:d,data:Q.data}))},gK.prototype.getEvent=function(a){for(var d=this.events,aW=0;aW<d.length;aW++)if(d[aW].id==a)return d[aW];return null},gK.prototype.updateEvents=function(d){var aW={data:this.data,changes:[]},g=this;a.isPlainObject(d)&&(d=[d]);var b,Q,e;a.each(d,function(d,ga){b=ga.event,Q=ga.changes,e={event:b,changes:[]},typeof b===E&&(b=g.getEvent(b)),b&&(a.isPlainObject(Q)&&(Q=[Q]),a.each(ga,function(d,aW){g.callEvent("beforeChange",{event:b,change:aW.change,to:aW.to,from:b[aW.change]})&&(e.changes.push(a.extend(!0,{},aW,{from:b[aW.change]})),b[aW.change]=aW.to)})),aW.changes.push(e)}),g.sortEvents(),g.display(),g.callEvent("change",aW)},gK.prototype.removeEvents=function(d){a.isArray(d)||(d=[d]);var aW,g,E,b=this.events,Q=this,e=[];a.each(d,function(d,ga){aW=a.isPlainObject(ga)?ga.id:ga,E=-1;for(var G=0;G<b.length;G++)if(b[G].id==aW){E=G,g=b[G];break}E>=0&&Q.callEvent("beforeRemoveEvent",{event:g,eventId:aW,data:Q.data})&&(b.splice(E,1),e.push(g))}),Q.sortEvents(),Q.display(),Q.callEvent("removeEvents",{removedEvents:e,data:Q.data})},gK.prototype.getOptions=function(d){this.options=a.extend({},gK.DEFAULTS,this.$.data(),d)},gK.prototype.getLang=function(){this.lang=this.options.langs[this.options.lang||(a.zui&&a.zui.clientLang?a.zui.clientLang():"zh-cn")]},gK.prototype.display=function(d,aW){var g=this,Q=typeof d,e=typeof aW;Q===b?d=g.view:g.view=d,e===b?aW=g.date:g.date=aW,"today"===aW&&(aW=new Date,g.date=aW),typeof aW===E&&(aW=new Date(aW),g.date=aW),g.options.storage&&a.zui.store.pageSet(g.storeName,{date:aW,view:d});var ga={view:d,date:aW};if(g.callEvent("beforeDisplay",ga)){switch(d){case"month":g.displayMonth(aW)}g.callEvent("display",ga)}},gK.prototype.displayMonth=function(d){var aW=this;d=d||aW.date;var g,E=aW.options,b=aW.lang,Q=aW.$views,G=(aW.$,aW.$monthView);if(!G.length){G=a('<div class="calendar-view month"><table class="table table-bordered"><thead><tr class="week-head"></tr></thead><tbody class="month-days"></tbody></table></div>');var dg,gK=G.find(".week-head"),dY=G.find(".month-days");for(g=0;g<7;g++)gK.append("<th>"+b.weekNames[g]+"</th>");for(g=0;g<6;g++){dg=a('<tr class="week-days"></tr>');for(var gd=0;gd<7;gd++)dg.append('<td class="cell-day"><div class="day"><div class="heading"><span class="month"></span> <span class="number"></span></div><div class="content"><div class="events"></div></div></div></td>');dY.append(dg)}Q.append(G),aW.$monthView=G}var eg,dQ,f,A,c,df,Gd,i,db,cK,eB,aZ=G.find(".week-days"),dX=(G.find(".day"),ga(d)),gE=new Date,aZa=e(dX),ad=d.getFullYear(),J=d.getMonth(),cM=gE.getMonth(),dS=gE.getFullYear(),gQ=gE.getDate(),aS=aZa.clone().addDays(42).addMilliseconds(-1),h=aZa.clone().addDays(1).addMilliseconds(-1),j=aW.getEvents(aZa,aS),k=aW.calendars;if(aZ.each(function(d){eg=a(this),eg.find(".day").each(function(aW){i=0===aW,dQ=a(this),f=dQ.closest(".cell-day"),A=h.getFullYear(),c=h.getDate(),df=h.getMonth(),Gd=h.toDateString(),dQ.attr("data-date",Gd),dQ.find(".heading > .number").text(c),dQ.find(".heading > .month").toggle(0===d&&0===aW||1===c).text((0===df&&1===c?b.year.format(A)+" ":"")+b.monthNames[df]),f.toggleClass("current-month",df===J),f.toggleClass("current",c===gQ&&df===cM&&A===dS),f.toggleClass("past",h<gE),f.toggleClass("future",h>gE),eB=dQ.find(".events").empty();var E=j[Gd];if(E){var Q,e=E.events,ga=0;for(g=0;g<=E.maxPos;++g)Q=e[g],!Q||Q.placeholder&&!i?ga++:(db=a('<div data-id="'+Q.id+'" class="event" title="'+Q.desc+'"><span class="time">'+Q.start.format("hh:mm")+'</span> <span class="title">'+Q.title+"</span></div>"),db.find(".time").toggle(!Q.allDay),db.data("event",Q),db.attr("data-days",Q.days),Q.calendar&&(cK=k[Q.calendar],cK&&(cK.presetColor?db.addClass("color-"+cK.color):db.css({"background-color":cK.color,color:cK.textColor}))),Q.days&&(Q.placeholder?i&&db.css("width",Math.min(7,Q.days-Q.holderPos)+"00%"):db.css("width",Math.min(7-aW,Q.days)+"00%")),ga>0&&(db.css("margin-top",22*ga),ga=0),eB.append(db))}h.addDays(1)})}),E.withHeader&&(aW.$caption.text(b.yearMonth.format(ad,J+1,b.monthNames[J])),aW.$todayBtn.toggleClass("disabled",J===cM&&ad===dS)),E.dragThenDrop){if(!a.fn.droppable)return console.error("Calendar dragThenDrop option requires droppable.js");G.data("zui.droppable")||G.droppable({target:".day",selector:".event",flex:!0,start:function(){aW.$.addClass("event-dragging")},drop:function(a){var d=a.element.data("event"),g=a.target.attr("data-date");if(d&&g){var E=d.start.clone();if(E.toDateString()!=g&&(g=new Date(g),g.setHours(E.getHours()),g.setMinutes(E.getMinutes()),g.setSeconds(E.getSeconds()),aW.callEvent("beforeChange",{event:d,change:"start",to:g}))){var b=d.end.clone();d.end.addMilliseconds(d.end.getTime()-E.getTime()),d.start=g,aW.display(),aW.callEvent("change",{data:aW.data,changes:[{event:d,changes:[{change:"start",from:E,to:d.start},{change:"end",from:b,to:d.end}]}]})}}},finish:function(){aW.$.removeClass("event-dragging")}})}},gK.prototype.getEvents=function(d,aW){var g={},E=(this.calendars,function(a,d,aW){var E=a.toDateString(),b=g[E];if(b||(b={maxPos:-1,events:{}}),"undefined"==typeof aW)for(var Q=0;Q<100;++Q)if(!b.events[Q]){aW=Q;break}return b.maxPos=Math.max(aW,b.maxPos),b.events[aW]=d,g[E]=b,aW});return a.each(this.events,function(g,b){if(b.start>=d&&b.start<=aW){var Q=E(b.start,b);if(b.days>1){var e=a.extend({placeholder:!0},b);dg(b.start.clone().addDays(1),b.end,function(d,aW){E(d.clone(),a.extend({holderPos:aW},e),Q)})}}}),g},gK.prototype.callEvent=function(a,d){var g=this.$.callEvent(a+"."+aW,d,this);return!(void 0!==g.result&&!g.result)},a.fn.calendar=function(d){return this.each(function(){var g=a(this),b=g.data(aW),Q="object"==typeof d&&d;b||g.data(aW,b=new gK(this,Q)),typeof d==E&&b[d]()})},a.fn.calendar.Constructor=gK}(jQuery,window);